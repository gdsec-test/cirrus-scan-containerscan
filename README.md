# cirrus-scan-containerscan

CirrusScan check: Container Scanner

[CirrusScan](https://github.secureserver.net/appservices/CirrusScan) utilizes
[Prisma Container Defender](https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin-compute/install/install_defender/install_single_container_defender.html)to identify compliance violations and vulnerabilities in container images in AWS ECR registries. Findings are forwarded to
[Security Hub](https://docs.aws.amazon.com/securityhub/latest/userguide/)
for presentation.

Refer to [docker/README.md](docker/README.md) for details on how to construct
and promote the container used for scanning. Note that all tailoring is
performed at container build time.

## Workflow

When a container scan is requested, the following activities take place:

1. CirrusScan will execute an ECS task in the specified AWS account to
   coordinate the scan.
2. If the target is specified by zone, the ECS task looks up the subnets
   associated with each zone and uses these as scan targets.
3. If a source is specified, the ECS task will provision an ephemeral
   OpenStack VM (if possible) or select a persistent scanner host (if necessary)
   located within the specified source zone. If multiple sources zones are
   specified, multiple scanner instances will be utilized. The special zone
   "aws" will cause the scanner to execute on the ECS task instance itself.
4. The masscan scanner will be invoked, using the target subnet list, at the
   desired source location(s).
5. Scan results will be transmitted to the ECS task instance (if the scanner was
   executed remotely).
6. Any ephemeral VMs created for the scan will be unprovisioned.
7. The raw data will be examined for nonconformances. For CMDB-assisted scans,
   responding IPv4 addresses will be matched to host CIs and then to a port
   template. If no lookup is made, or a template cannot be found, the default
   template specified by the request will be used.
8. A Security Hub finding will be generated for each open port which does not
   match the relevant template. Where available, this finding will be enriched
   with CI identification and the supporting ServiceNow oncall team.
9. CirrusScan libraries transparently correlate these findings with earlier
   observations, resulting in the automatic creation, update or archiving of
   Security Hub findings as appropriate. (CirrusScan subsequently forwards these
   findings to ServiceNow, opening or closing tickets as required.)
10. The ECS task instance stores output and status data in S3 for further review.
11. The ECS task terminates.

## Logging and Debugging

After launching a scan from API gateway, the requester may go to the ECS
dashboard from AWS console and verify that an ECS task named **portscan** is running.

Next, to find debugging logs from the container, go to Cloudwatch logs, and
filter logs by **/ecs/portscan**. You should see the debugging logs from the
portscan container in the most recent log stream. Please verify the last event time.
  
## Security Findings

By design, all portscan findings are created with severity **HIGH**.
Findings generated by this check can be found by applying following filters on
Security Hub:

* Record State _EQUALS_ ACTIVE
* ID _PREFIX_ portscan/
  
For any further assistance, please reach out to DL-AppSecurity@godaddy.com.
